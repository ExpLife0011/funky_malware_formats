#include <iostream>
#include <windows.h>

#include "file_util.h"
#include "lotus_headers.h"

DWORD* print_dwords(DWORD *buf, size_t num)
{
	for (size_t i = 0; i < num; i++) {
		std::cout << " : " << std::hex << buf[i];
	}
	std::cout << std::endl;
	return buf + num;
}

void print_ep(BYTE *part1, lotus::entry_point_t* ep)
{
	std::cout << "Entry Point: " << std::hex << ep->entry_rva << " : ";
	if(ep->name_rva == 0) {
		std::cout << ep->name_rva <<" (unnamed)\n";
	}
	else {
		char* name_ptr = (char*)(part1 + ep->name_rva);
		std::cout << std::hex << ep->name_rva << " " << name_ptr << std::endl;
	}
}

void print_imports(BYTE *part1, lotus::import_t* imp)
{
	if (!imp || !part1) return;

	char* dll_ptr = (char*)(part1 + imp->dll_rva);
	char* imp_ptr = (char*)(part1 + imp->func_rva);
	//TODO: check the pointers
	std::cout << std::hex << imp->dll_rva <<  " : " << dll_ptr << std::endl;
	std::cout << std::hex << imp->func_rva << " : " << imp_ptr << std::endl;
}

void print_table(BYTE *content, size_t content_size, size_t module_size)
{
	BYTE *code_part = content + sizeof(lotus::header1_t);
	size_t code_size = content_size - sizeof(lotus::header1_t);

	DWORD *table = lotus::get_records(content, content_size);
	size_t i = 0;

	size_t args_by_type[4];
	args_by_type[lotus::NO_TYPE] = 0;
	args_by_type[lotus::RELOC_TYPE] = 1;
	args_by_type[lotus::EP_TYPE] = 3;
	args_by_type[lotus::IMPORT_TYPE] = 4;

	while (true) {
		DWORD type = table[i++];
		std::cout << "type: " << std::hex << type;
		size_t arg_num = args_by_type[type];
		if (type == lotus::NO_TYPE) break;

		print_dwords(&table[i], arg_num);

		switch (type) {
		case lotus::RELOC_TYPE:
			break;
		case lotus::EP_TYPE:
			print_ep(code_part, (lotus::entry_point_t*) &table[i]);
			break;
		case lotus::IMPORT_TYPE:
			print_imports(code_part, (lotus::import_t*) &table[i]);
			break;
		}
		table += arg_num;
	}
}

int main(int argc, char *argv[])
{
	if (argc < 2) {
		std::cout << "Args: <module>" << std::endl;
		system("pause");
		return -1;
	}
	size_t content_size = 0;
	BYTE *content = load_file(argv[1], content_size);
	if (!content) {
		std::cerr << "Failed to load: " << argv[1] << std::endl;
		return -1;
	}
	std::cout << "Loaded: " << argv[1] << "\nLoaded size: " << std::hex << content_size << std::endl;
	if (!lotus::decode_file(content, content_size)) {
		std::cerr << "Decoding failed!" << std::endl;
		return -2;
	}
	lotus::header1_t *hdr1 = lotus::get_hdr1(content, content_size);
	if (!hdr1) {
		return -2;
	}
	std::cout << "\nHDR1: \nprolog: " << std::hex << hdr1->prolog
		<< "\ncode size: " << std::hex << hdr1->code_size
		<< "\n---" << std::endl;

	lotus::header2_t *hdr2 = lotus::get_hdr2(content, content_size);
	if (!hdr2) {
		return -3;
	}
	std::cout << "HDR2: \nprolog: " << std::hex << hdr2->prolog
		<< "\nIAT size: " << std::hex << hdr2->iat_size
		<< "\n---\n" << std::endl;

	print_table(content, content_size, hdr1->code_size);
	//system("pause");
	return 0;
}
